const $usernameInput=$("#usernameInput"),$calculateEngagementBtn=$("#calculateEngagementBtn"),defaultProfileUrl="https://nitreo.com/img/igDefaultProfilePic.png";let activeNav="POSTS",results={},prevUsername="",loading=!1;const isError={error:!1},lastCounterValues={followerCount:"0",totalPosts:"0",averageComments:"0",averageLikes:"0",engagementRate:"0"};function loadImage(e){x=document.getElementById("avatar"),x.src=e,x.style.opacity="0"}let intervalID;function checkImageHasLoaded(){x=document.getElementById("avatar"),x.complete&&($("#avatar").css("opacity","0").animate({opacity:1},1e3),clearInterval(intervalID))}function renderImage(e){loadImage(e),intervalID=setInterval(checkImageHasLoaded,0)}$(".nav li a").click(function(e){$(".active").removeClass("active");const t=$(this).text();activeNav!==t&&(activeNav=t,renderResults(t,results,!1),$(this).addClass("active"),e.preventDefault())}),$usernameInput.on("input",()=>{$("#errorMessage").html(""),$usernameInput.val()?$calculateEngagementBtn.attr("disabled",!1):$calculateEngagementBtn.attr("disabled",!0)});const getEngagementResults=async()=>{if(!document.cookie.includes("nitreoEmail"))return $("#myModal").modal();if((prevUsername!==$usernameInput.val()||!1!==isError.error)&&!loading){$("#errorMessage").html(""),loading=!0,$("#calculateEngagementBtn").html('<span class="spinner-border spinner-border-sm"></span>');try{const e=await fetch("https://ig-engagement-api.herokuapp.com/calculateEngagement",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:usernameInput.value.replace(/[^a-zA-Z0-9._]+/g,"")})}),t=await e.json();t.error?(isError.error=!0,$("#errorMessage").text(t.error)):(renderResults(activeNav,t,!0),results=t,isError.error=!1)}catch(e){console.log("ERROR: ",e),$("#errorMessage").text("Connection timed out, please try again"),isError.error=!0}finally{$("#calculateEngagementBtn").html("Calculate Engagement"),loading=!1,prevUsername=$usernameInput.val()}}},counters=[],counterAnimation=(e,t,a=1e3)=>{if(0==Number(e.replace(/[^0-9.]/g,"")).toFixed(1)&&0==Number(lastCounterValues[t].replace(/[^0-9.]/g,"")).toFixed(1))return;let n={Counter:0};"followerCount"!==t&&counters.push(n);const r=Number(e.replace(/[^0-9.]/g,""));0==r&&(n.Counter=Number(lastCounterValues[t].replace(/[^0-9.]/g,"")));let o=e[e.length-1];isNaN(Number(o))||(o=""),$(n).animate({Counter:r},{duration:a,easing:"swing",step:function(){r<1e3&&!o?$("#"+t).text(`${Math.ceil(this.Counter)}${o}`):$("#"+t).text(`${this.Counter.toFixed(1)}${o}`)},complete:function(){r<1e3&&!o||"0%"===e?$("#"+t).text(`${Math.ceil(this.Counter)}${o}`):$("#"+t).text(`${this.Counter.toFixed(1)}${o}`)}}),lastCounterValues[t]=e},renderResults=(e,t,a)=>{let n="0",r="0",o="0",i="0%",s="0",l="",c=!1,m=!1,u=defaultProfileUrl;if(Object.keys(t).length)switch(u=t.avatarUrl,l=t.username,c=t.verified,s=t.followers,m=t.private,e){case"POSTS":n=t.posts.total,r=t.posts.averageComments,o=t.posts.averageLikes,i=t.posts.engagementRate;break;case"IGTV":n=t.igTv.total,r=t.igTv.averageComments,o=t.igTv.averageLikes,i=t.igTv.engagementRate;break;case"TOTAL":default:n=t.totalPosts,r=t.averageComments,o=t.averageLikes,i=t.engagementRate}a?(renderImage(u),m?$("#privateAccountMessage").html("This Account is Private"):$("#privateAccountMessage").html(""),c?$("#username").html(`${l} <img class="blue-tick" alt="verification tick" src="https://nitreo.com/img/verified-icon.png"/>`).hide().fadeIn(1e3):$("#username").text(l).hide().fadeIn(1e3),counterAnimation(s,"followerCount"),counterAnimation(n,"totalPosts"),counterAnimation(r,"averageComments"),counterAnimation(o,"averageLikes"),counterAnimation(i,"engagementRate")):(counters.forEach(e=>$(e).stop()),counterAnimation(n,"totalPosts",250),counterAnimation(r,"averageComments",250),counterAnimation(o,"averageLikes",250),counterAnimation(i,"engagementRate",250))};let mauticLoading=!1;async function mautic(e){if($("#emailErrorMsg").html(""),!mauticLoading){$("#modal-continue").prop("disabled",!0);try{mauticLoading=!0;const t=await fetch("https://ig-engagement-api.herokuapp.com/mautic",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});(await t.json()).invalidEmail?($("#modal-continue").prop("disabled",!1),$("#emailErrorMsg").html('<div class="alert alert-danger small">Please enter a valid Email</div>')):($("#myModal").modal("toggle"),writeCookie("nitreoEmail",e,"336"),getEngagementResults())}catch(e){console.log(e)}finally{mauticLoading=!1}}}function writeCookie(e,t,a){let n=new Date;n.setTime(+n+36e5*a),document.cookie=e+"="+t+"; expires="+n.toGMTString()+"; path=/"}document.getElementById("modal-form").addEventListener("submit",function(e){e.preventDefault(),mautic(document.querySelector("#modal-email-input").value)});