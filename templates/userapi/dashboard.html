{% extends "userapi/base.html" %}
{% load static %}

{% block head %}
<title>Dashboard - MassNova</title>
<link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<style>
  .apexcharts-toolbar {
    z-index: 1 !important;
  }
</style>
{% endblock %}

{% block content %}
{% include "userapi/dashboard_header.html" %}
<!--start main wrapper-->
<main class="main-wrapper">
  <div class="main-content">
    <!--breadcrumb-->
    <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
      <div class="breadcrumb-title pe-3">MassNova</div>
      <div class="ps-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0 p-0">
            <li class="breadcrumb-item active" aria-current="page">Dashboard</li>
          </ol>
        </nav>
      </div>
    </div>
    <!--end breadcrumb-->
    {% include "userapi/messages_snippet.html" %}
    <p class="text-danger my-2"><strong id="message"></strong></p>
    <div class="container">
      <div class="d-flex align-items-center justify-content-center my-2">
        <input type="text" class="datepicker form-control" name="from" id="from" placeholder="dd-mm-yyyy">
        <span class="mx-2"> to </span>
        <input type="text" class="datepicker form-control" name="to" id="to" placeholder="dd-mm-yyyy">
        <div class="ms-3">
          <button type="button" class="btn btn-primary btn-sm text-md-nowrap" data-bs-toggle="modal" data-bs-target="#instaUser">Select Insta Account</button>
        </div>
      </div>
    </div>
    <!-- Charts -->
    <div class="row">
      <div class="col-12 col-xl-6">
        <div class="card">
          <div class="card-header py-3">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="mb-0">Followers History</h5>
            </div>
          </div>
          <div class="card-body">
            <div id="followersChart"></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-6">
        <div class="card">
          <div class="card-header py-3">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="mb-0">Engagement Rate</h5>
            </div>
          </div>
          <div class="card-body">
            <div id="engagementRateChart"></div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card">
          <div class="card-header py-3">
            <div class="d-flex align-items-center justify-content-between">
              <h5 class="mb-0">Likes and Comments</h5>
            </div>
          </div>
          <div class="card-body">
            <div id="likeCommentChart"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<!--end main wrapper-->

<!-- Settings Modal -->
<div class="modal fade" id="instaUser" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="get" onsubmit="return check()">
        <div class="modal-header">
                <h5 class="modal-title">
                  Select Instagram Account
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="d-flex align-items-center">
                <select class="form-select text-center" id="settingsDropdown" name="insta_account">
                    <option value="#">------</option>
                    {% for insta_cred in insta_creds %}
                    <option value="{{ insta_cred.username }}" {% if request.GET.insta_account == insta_cred.username %} selected {% endif %}>
                      {{ insta_cred.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Select</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Settings Modal End-->

{% include "userapi/dashboard_footer.html" %}

<script src="{% static '' %}bs/plugins/apexchart/apexcharts.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script>
  $(document).ready(function () { 
    var options = {
      chart: {
        type: "area",
      },
      dataLabels: {
        enabled: false
      },
      series: [{
        name: 'Followers',
        data: {{ followers }}
      }],
      colors: ["#0000FF"],
      fill: {
        type: "gradient",
        gradient: {
          shadeIntensity: 1,
          opacityFrom: 0.7,
          opacityTo: 0.9,
          stops: [0, 90, 100]
        }
      },
      xaxis: {
        categories: [1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999]
      },
      stroke: {
        curve: 'smooth',
      }
    }

    new ApexCharts($("#followersChart")[0], options).render();

    var engagementRateData = {{ engagement_rate }};
    var engagementRateValue = engagementRateData.length > 0 ? engagementRateData[0] : 0;

    var options = {
      chart: {
        type: "radialBar",
      },
      series: [engagementRateValue],
      colors: ["#00FF00"],
      plotOptions: {
        radialBar: {
          startAngle: -135,
          endAngle: 135,
          track: {
            background: '#333',
            startAngle: -135,
            endAngle: 135,
          },
          dataLabels: {
            name: {
              show: false,
            },
            value: {
              fontSize: "30px",
              show: true
            }
          }
        }
      },
      fill: {
        type: "gradient",
        gradient: {
          shade: "dark",
          type: "horizontal",
          stops: [0, 100]
        }
      },
      stroke: {
        lineCap: "butt"
      },
      labels: ["Progress"]
    };

    new ApexCharts($("#engagementRateChart")[0], options).render();

    var options = {
      series: [{
        name: 'Likes',
        data: {{ like }}
      },
      {
        name: 'Comments',
        data: {{ comment }}
      }],
      chart: {
        width: "100%",
        height: 380,
        type: 'bar',
      },
      plotOptions: {
        bar: {
          horizontal: false,
          columnWidth: '70%',
          endingShape: 'rounded'
        },
      },
      stroke: {
        show: true,
        width: 4,
        colors: ['transparent']
      },
      dataLabels: {
        enabled: false
      },
      colors: ["#00D4F9", "#00E647"],
      xaxis: {
        categories: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
      },
      yaxis: {
        title: {
          text: 'Count'
        }
      },
    };

    new ApexCharts($("#likeCommentChart")[0], options).render();

    var userOffset = new Date().getTimezoneOffset();
    var userToday = new Date(Date.now() - userOffset * 60000);

    // Format the date as "YYYY-MM-DD"
    var formattedDate = userToday.toISOString().split("T")[0];

    $('.datepicker').datepicker({
      dateFormat: "dd-mm-yy"
    });
  });

  function check() {
    if ($('#settingsDropdown').val() == '#') {
      let message = 'Please select Instagram Account.';
      // Display the message
      $("#message").append(message);
      setTimeout(function () {
          $("#message").text("");
      }, 7000);
      return false;
    }
    return true;
  }
</script>
{% endblock %}