{% load static %}
<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static '' %}media/icon.png" type="image/x-icon">
    <!--plugins-->
    <link href="{% static '' %}bs/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static '' %}bs/plugins/metismenu/metisMenu.min.css">
    <link rel="stylesheet" type="text/css" href="{% static '' %}bs/plugins/metismenu/mm-vertical.css">
    <!--main css-->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="{% static '' %}bs/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static '' %}bs/css/bootstrap-extended.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/boxicons/2.1.0/css/boxicons.min.css" rel="stylesheet">
    <link href="{% static '' %}bs/sass/main.css" rel="stylesheet">
    <link href="{% static '' %}bs/sass/responsive.css" rel="stylesheet">
    {% block head %}{% endblock %}
    <style>
      @media (max-width: 767px) {
        ::placeholder {
          font-size: 12px;
        }
      }
    </style>
  </head>

  <body>
    {% block content %}{% endblock content %}

    <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
    <script>
      $(document).ready(function () {
        fetch('/notifications/', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then(response => response.json())
          .then(data => {

            // Clear existing notifications
            $("#dynamic-notifications").empty();

            let newNotifications = 0;

            // Loop through the recent entries and add dynamic notifications
            data.forEach(notification => {
              const timestamp = moment(notification.time_stamp);
              const timeAgo = timestamp.fromNow();

              // Determine the class based on whether the notification is read or not
              const highlightClass = notification.read ? '' : 'bg-primary-subtle';

              if (!notification.read) {
                newNotifications += 1;
              }

              $("#dynamic-notifications").append(`
                  <div>
                      <a class="dropdown-item border-bottom py-2 ${highlightClass}" href="javascript:;">
                          <div class="d-flex align-items-center gap-3">
                              <div class="">
                                  <h5 class="notify-title">Followers: ${notification.followers}</h5>
                                  <p class="mb-0 notify-desc">${notification.engagement_rate}</p>
                                  <p class="mb-0 notify-time">${timeAgo}</p>
                              </div>
                          </div>
                      </a>
                  </div>
              `);
            });

            if (newNotifications > 0) {
              $("#newNotifications").removeClass('d-none');
              $("#newNotifications").append(`${newNotifications}`);
            }
          })
          .catch(error => {
            // Handle network or other errors
            alert('Error retrieving notifications:', error);
          });

        $("#markAllAsRead").click(function () {
          let unread = document.getElementById("newNotifications").innerText;
          if (unread) {
            let form = document.getElementById('notifications-form');
            let csrfToken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

            fetch('/notifications/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
              },
            })
              .then(response => {
                if (!response.ok) {
                  throw new Error('Failed to mark all notifications as read.');
                }
                return response.json();
              })
              .then(data => {
                // Update the UI or perform any other necessary actions
                $("#newNotifications").addClass('d-none');
                let highlightedNotifications = $(".bg-primary-subtle");
                highlightedNotifications.each(function (index, element) {
                  $(element).removeClass("bg-primary-subtle");
                });
              })
              .catch(error => {
                console.error('Error marking notifications as read:', error);
                alert('Error marking notifications as read.');
              });
          } else {
            alert("No unread notification!");
          }
        });

        $('[data-toggle="tooltip"]').tooltip();

        $("#show_hide_password a").on('click', function (event) {
          event.preventDefault();
          if ($('#show_hide_password input').attr("type") == "text") {
            $('#show_hide_password input').attr('type', 'password');
            $('#show_hide_password i').addClass("bi-eye-slash-fill");
            $('#show_hide_password i').removeClass("bi-eye-fill");
          } else if ($('#show_hide_password input').attr("type") == "password") {
            $('#show_hide_password input').attr('type', 'text');
            $('#show_hide_password i').removeClass("bi-eye-slash-fill");
            $('#show_hide_password i').addClass("bi-eye-fill");
          }
        });
      });

      function handleMessages() {
        const messageDivs = document.querySelectorAll('.alert');

        messageDivs.forEach((messageDiv) => {
          const displayTime = parseInt(messageDiv.dataset.displayTime);

          // Set a timeout to hide the message after the specified display time
          setTimeout(() => {
            messageDiv.style.display = 'none';
          }, displayTime);
        });
      }
      // Call the function when the DOM is loaded
      document.addEventListener('DOMContentLoaded', handleMessages);

    </script>
  </body>

</html>