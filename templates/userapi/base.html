{% load static %}
<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static '' %}media/icon.png" type="image/x-icon">
    <!--plugins-->
    <link href="{% static '' %}bs/plugins/perfect-scrollbar/css/perfect-scrollbar.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{% static '' %}bs/plugins/metismenu/metisMenu.min.css">
    <link rel="stylesheet" type="text/css" href="{% static '' %}bs/plugins/metismenu/mm-vertical.css">
    <!--main css-->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="{% static '' %}bs/css/bootstrap.min.css" rel="stylesheet">
    <link href="{% static '' %}bs/css/bootstrap-extended.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/boxicons/2.1.0/css/boxicons.min.css" rel="stylesheet">
    <link href="{% static '' %}bs/sass/main.css" rel="stylesheet">
    <link href="{% static '' %}bs/sass/responsive.css" rel="stylesheet">
    {% block head %}{% endblock %}
    <style>
      @media (max-width: 767px) {
        ::placeholder {
          font-size: 12px;
        }
      }
    </style>
  </head>

  <body>
    {% block content %}{% endblock content %}

    <script>
      $(document).ready(function () {
        $('[data-toggle="tooltip"]').tooltip();
      });

      function handleMessages() {
        const messageDivs = document.querySelectorAll('.alert');

        messageDivs.forEach((messageDiv) => {
          const displayTime = parseInt(messageDiv.dataset.displayTime);

          // Set a timeout to hide the message after the specified display time
          setTimeout(() => {
            messageDiv.style.display = 'none';
          }, displayTime);
        });
      }
      // Call the function when the DOM is loaded
      document.addEventListener('DOMContentLoaded', handleMessages);

      $(document).ready(function () {
        $("#show_hide_password a").on('click', function (event) {
          event.preventDefault();
          if ($('#show_hide_password input').attr("type") == "text") {
            $('#show_hide_password input').attr('type', 'password');
            $('#show_hide_password i').addClass("bi-eye-slash-fill");
            $('#show_hide_password i').removeClass("bi-eye-fill");
          } else if ($('#show_hide_password input').attr("type") == "password") {
            $('#show_hide_password input').attr('type', 'text');
            $('#show_hide_password i').removeClass("bi-eye-slash-fill");
            $('#show_hide_password i').addClass("bi-eye-fill");
          }
        });
      });

      $(document).ready(function () {
        let url = '/stat/';

        fetch(url, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': "Token {{ request.session.token }}"
          },
        })
          .then(response => response.json())
          .then(data => {
            // Clear existing notifications
            const recentEntries = data.slice(0, 5);

            // Clear existing notifications
            $("#dynamic-notifications").empty();

            // Function to calculate the time difference in a human-readable format
            function timeDifference(current, previous) {
              const msPerMinute = 60 * 1000;
              const msPerHour = msPerMinute * 60;
              const msPerDay = msPerHour * 24;
              const msPerMonth = msPerDay * 30;
              const msPerYear = msPerDay * 365;

              const elapsed = current - previous;

              if (elapsed < msPerMinute) {
                return Math.round(elapsed / 1000) + ' seconds ago';
              } else if (elapsed < msPerHour) {
                return Math.round(elapsed / msPerMinute) + ' minutes ago';
              } else if (elapsed < msPerDay) {
                return Math.round(elapsed / msPerHour) + ' hours ago';
              } else if (elapsed < msPerMonth) {
                return Math.round(elapsed / msPerDay) + ' days ago';
              } else if (elapsed < msPerYear) {
                return Math.round(elapsed / msPerMonth) + ' months ago';
              } else {
                return Math.round(elapsed / msPerYear) + ' years ago';
              }
            }

            // Loop through the recent entries and add dynamic notifications
            recentEntries.forEach(notification => {
              const timestamp = new Date(notification.time_stamp);
              const timeAgo = timeDifference(new Date(), timestamp);

              $("#dynamic-notifications").append(`
                  <div>
                      <a class="dropdown-item border-bottom py-2" href="javascript:;">
                          <div class="d-flex align-items-center gap-3">
                              <div class="">
                                  <h5 class="notify-title">Followers: ${notification.followers}</h5>
                                  <p class="mb-0 notify-desc">${notification.engagement_rate}</p>
                                  <p class="mb-0 notify-time">${timeAgo}</p>
                              </div>
                              <div class="notify-close position-absolute end-0 me-3">
                                  <i class="material-icons-outlined fs-6">close</i>
                              </div>
                          </div>
                      </a>
                  </div>
              `);
            });
          })
          .catch(error => {
            // Handle network or other errors
            alert('Error during delete request:', error);
          });
      });
    </script>
  </body>

</html>