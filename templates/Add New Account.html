{% load static %}
<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
        <meta name="theme-color" content="#fff">
        <meta name="description" content="Instagram Growth Tool - Stellation Media">
        <meta name="keywords" content="instagram, growth tool, instagram growth, instagram targeted growth, Instagram followers">
        <link rel="icon" href="{% static '' %}Targeting Settings_files/sisomade-66a2a8e5a60ed.png" type="image/x-icon">
        <link rel="shortcut icon" href="{% static '' %}Targeting Settings_files/sisomade-66a2a8e5a60ed.png" type="image/x-icon">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-line-icons@2.5.5/css/simple-line-icons.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="{% static '' %}Targeting Settings_files/plugins.css">
        <link rel="stylesheet" type="text/css" href="{% static '' %}Targeting Settings_files/core.css">
        <link rel="stylesheet" type="text/css" href="{% static '' %}Targeting Settings_files/core(1).css">
        <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <title>Add New Account</title>
        <style>
            .error-message {
                color: red;
                margin-top: 5px;
            }

            input[aria-invalid="true"] {
                border-color: red;
                /* Visual feedback for invalid inputs */
            }

            #loading-overlay {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                justify-content: center;
                align-items: center;
            }

            #loading-overlay > section {
                padding: 20px;
                border-radius: 8px;
                text-align: center;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                margin: 0 auto 15px;
                animation: spin 1s linear infinite;
            }

            .loading-text {
                font-size: 16px;
            }

            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
    </head>

    <body>
        {% include "nav.html" %}
        <div class="skeleton proxy-manager-pro" id="pmp-account">
            <div class="section-header back-button-wh none pt-10">
                <a href="/accounts">
                    <span class="mdi mdi-reply"></span>Back </a>
            </div>
            <form autocomplete="off" id="account-form">
                <div class="container-1200">
                    <div class="row clearfix">
                        <div class="col s12 m8 l4 mb-20">
                            <div class="clearfix">
                                <div class="col s12 m12 l12 js-hide-aa-notice">
                                    <section class="section mb-20">
                                        <div class="section-content aa-notice ">
                                            <p>We have a <strong>100% success connecting accounts.&nbsp;</strong><br>
                                                If you are having issues, check out
                                                <a href="#">this help guide</a>.
                                            </p>
                                            <div>
                                            </div>
                                        </div>
                                    </section>
                                </div>
                            </div>
                            <section class="section">
                                <div class="section-content">
                                    <div class="form-result">
                                    </div>
                                    <div class="js-login">
                                        <div class="mb-20">
                                            <label class="form-label">
                                                Username </label>
                                            <input class="input" name="username" type="text" placeholder="Enter username" maxlength="70">
                                        </div>
                                        <div class="mb-20">
                                            <label class="form-label">
                                                Password </label>
                                            <input class="input" name="password" type="password" placeholder="Enter password">
                                        </div>
                                        <div class="clearfix">
                                            <div class="mb-10">
                                                <label class="form-label">
                                                    Platform </label>
                                                <select class="input" name="platform">
                                                    <option value="mobile">Mobile</option>
                                                    <option value="desktop">Desktop</option>
                                                </select>
                                                <ul class="field-tips">
                                                    <li>Here you can select the platform for the emulated device. There is
                                                        no big difference, optionally.</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <!-- Wesley Start Mod -->
                                        <!-- Wesley End Mod -->
                                        <div class="clearfix">
                                            <div class="mb-20">
                                                <label class="form-label">
                                                    Verification </label>
                                                <select class="input" name="choice">
                                                    <option value="1">E-mail</option>
                                                    <option value="2">Mobile phone</option>
                                                    <option value="4">Login confirm from trusted device</option>
                                                    <option value="5">Backup codes</option>
                                                    <option value="6">WhatsApp</option>
                                                </select>
                                                <ul class="field-tips">
                                                    <li>Sometimes Instagram can ask you to verify your identity, choose
                                                        preferred verification method.</li>
                                                    <li>Email method is used by default.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="js-browser-extension none">
                                        <div class="mb-20">
                                            <label class="form-label">
                                                Attach Instagram Cookies </label>
                                            <ul class="field-tips-ext">
                                                <li class="mb-5">By this link install <a href="https://chromewebstore.google.com/detail/milk-%E2%80%94-cookie-manager/haipckejfdppjfblgondaakgckohcihp" target="_blank">MILK — Cookie Manager</a> extension for Google Chrome,
                                                    Opera and Firefox.</li>
                                                <li class="mb-5">Go to <a target="_blank" href="https://www.instagram.com/">Instagram</a> website and login to
                                                    your account.</li>
                                                <li class="mb-5">Click on the extension then the settings icon(three vertical dots) Export cookies file in JSON format by clicking <b>Download</b>.</li>
                                                <li class="mb-5">Attach that file to the form below.</li>
                                            </ul>
                                        </div>
                                        <div class="mb-20 cookie-file-extension">
                                            <label class="form-label">Cookie file</label>
                                            <div class="pos-r">
                                                <input class="input inputfile-session rightpad" name="cookie-file" type="file" id="cookie-file" style="display: none;">
                                                <label class="input cookie-file-label" for="cookie-file">
                                                    <span>Click to upload cookies file</span>
                                                    <span class="mdi mdi-folder field-icon--right"></span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="js-login">
                                    <input class="fluid button button--footer js-login" type="submit" value="Add account">
                                </div>
                            </section>
                        </div>
                        <div class="col s12 m8 l8 mr-0 js-hide-aa-message">
                            <section class="section">
                                <div class="section-content aa-message">
                                    <p><strong>ACCOUNT CONNECT CHECKLIST&nbsp;</strong></p>
                                    <ol>
                                        <li>
                                            <p>Make sure you are logged into your Instagram account on your smartphone</p>
                                        </li>
                                        <li>
                                            <p>Make sure that the password, email and phone numbers linked to your Instagram
                                                are correct</p>
                                        </li>
                                        <li>
                                            <p>Once you connect, select <strong>THIS WAS ME</strong>&nbsp;"We noticed a new
                                                login from United States"</p>
                                        </li>
                                        <li>
                                            <p>If you did not recieve a 6 digit code via EMAIL, check your SPAM and SOCIAL
                                                tabs</p>
                                        </li>
                                        <li>
                                            <p>If you did not recieve a 6 digit code via SMS, wait 60 seconds then click
                                                RESEND</p>
                                        </li>
                                    </ol>
                                    <p><strong>CANT CONNECT?</strong></p>
                                    <ol>
                                        <li>
                                            <p>Delete your accounts recent login activity.&nbsp;&nbsp;<a href="https://help.instagram.com/2761108904184084" target="_blank">Check
                                                    out this guide</a> from Instagram</p>
                                        </li>
                                        <li>
                                            <p>Change your Instagram password and reconnect your account, this resets the
                                                API</p>
                                        </li>
                                        <li>
                                            <p>If you are still unable to connect, come back in a couple hours and try again
                                            </p>
                                        </li>
                                        <li>
                                            <p>You can also turn off 2FA. <a href="https://help.instagram.com/1124604297705184" target="_blank">Check
                                                    out this guide</a> from Instagram</p>
                                        </li>
                                        <li>
                                            <p>If you are still having problems, please contact live chat or&nbsp;<a href="mailto:support@stellationmedia.com?subject=I%20Can%27t%20Connect%20My%20Account&amp;body=Hey%20Support%20Team%2C%0A%0AI%20am%20having%20trouble%20connecting%20my%20account.%20%0A%0ACan%20you%20please%20help%20me%20out%3F%0A%0AThanks">email
                                                    us</a>.&nbsp;</p>
                                        </li>
                                    </ol>
                                    <div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <script type="text/javascript" src="{% static '' %}Targeting Settings_files/plugins.js"></script>
        <script type="text/javascript" charset="utf-8">
            var __ = function (msgid) {
                return window.i18n[msgid] || msgid;
            };
            window.i18n = {
                // Cache Refresh modification
                'Cache successfully cleared': 'Cache successfully cleared',
                'Are you sure?': 'Are you sure?',
                'It is not possible to get back removed data!': 'It is not possible to get back removed data!',
                'Yes, Delete': 'Yes, Delete',
                'Cancel': 'Cancel',
                'Fill required fields': 'Fill required fields.',
                'Please select at least 2 media album post.': 'Please select at least 2 media album post.',
                'Please select one media for story post.': 'Please select one media for story post.',
                'Please select one media for post.': 'Please select one media for post.',
                'Please select an Instagram account to post.': 'Please select an Instagram account to post.',
                'Oops! An error occured. Please try again later!': 'Oops! An error occured. Please try again later!',
                'Use the TAB key to insert emoji faster': 'Use the TAB key to insert emoji faster',
                'Total Posts': 'Total Posts',
                'Followers': 'Followers',
                'Following': 'Following',
                'Uploading...': 'Uploading...',
                'Do you really want to cancel automatic payments?': 'Do you really want to cancel automatic payments?',
                'Yes, cancel automatic payments': 'Yes, cancel automatic payments',
                'No': 'No',
                'Verification': 'Verification',
                'Searching for %s': 'Searching for %s...',
                '+%s more': '+%s more',
                // Account Login Activity
                "Login Activity": 'Login Activity',
                "Active now": 'Active now',
                "Log Out": 'Log Out',
                "This Apple iPhone": 'This Apple iPhone',
                "Apple iPhone": 'Apple iPhone',
                "Where You're Logged in": 'Where You\'re Logged in',
                "Was This You?": 'Was This You?',
                "This Was Me": 'This Was Me',
                "This Wasn’t Me": 'This Wasn’t Me',
                // Account Change Password
                "New Password": 'New Password',
                "Change Password": 'Change Password',
                "Update Password": 'Update Password',
                // Insights Basic
                "Date": 'Date',
                "Month": 'Month',
                "Day of the week": 'Day of the week',
                "Instagram-report": 'Instagram-report',
                "Export data": 'Export data',
                "for a week": 'for a week',
                "for a month": 'for a month',
                "for a year": 'for a year'
            };
            $.fn.datepicker.language['en-US'] = {
                days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                daysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                daysMin: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
                months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                monthsShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                today: 'Today',
                clear: 'Clear',
                dateFormat: 'mm/dd/yyyy',
                timeFormat: 'hh:ii aa',
                firstDay: 1
            };
            if (typeof $.fn.oneFileManager !== 'undefined') {
                $.fn.oneFileManager.i18n["en-US"] = {
                    selectFiles: 'Select files',
                    loadMoreFiles: 'Load more',
                    viewFile: 'View',
                    deleteFile: 'Delete',
                    urlInputPlaceholder: 'Paste your link here...',
                    emptyVolume: 'Your media volume is empty. <br /> Drag some files here.',
                    dropFilesHere: 'Drop files here to upload',
                    deleteFileConfirm: 'This file and all uncompleted posts which this file is assigned to will be removed. This process cannot be undone. Do you want to proceed?',
                    bigFileSizeError: 'File size exceeds max allowed file size.',
                    fileTypeError: 'File type is not allowed.',
                    noEnoughVolumeError: 'There is not enough storage to upload this file',
                    queueSizeLimit: 'There are so many files in upload queue. Please try again after current upload queue finishes.',
                    deleteMessage: '{count} file(s) selected.',
                    deleteMessageBtn: 'Remove?',
                    removeSelectionConfirmation: 'Do you want to remove the selected files? This process can not be undone.',
                    usedXofY: 'Used {used} of {total}',
                    usedX: 'Used {used}',
                    total: 'Total',
                    xfiles: '{count} files',
                    remainingStorage: 'Remaining storage',
                    maxUploadSize: 'Max. file size to upload',
                    unlimitedStorage: 'Unlimited storage',
                    clearStorage: 'Clear storage',
                    clearStorageConfirm: 'Do you really want to remove all of your files? Your scheduled posts will not be published. This action not be undone.',
                };
            }
        </script>
        <script type="text/javascript" src="{% static '' %}Targeting Settings_files/core.js"></script>
        <script type="text/javascript" src="{% static '' %}Targeting Settings_files/core(1).js"></script>
        <script>
            function validateForm() {
                const username_el = document.querySelector('input[name="username"]');
                const password_el = document.querySelector('input[name="password"]');

                // If either validation fails, focus on the first invalid input
                if (!validateUsername(username_el.value)) {
                    username_el.focus();
                    return false;
                }

                if (!validatePassword(password_el.value)) {
                    password_el.focus();
                    return false;
                }
                return true;
            }

            function validateUsername(username) {
                username = username.trim().toLowerCase();
                const usernameRegex = /^[a-zA-Z][a-zA-Z0-9._]*[a-zA-Z0-9_]$/;
                if (username.length < 4 || username.length > 30) {
                    showError('username-error', 'Username must be between 4 and 30 characters');
                    return false;
                }

                // Check if it looks like an email
                if (username.includes('@')) {
                    showError('username-error', 'Username cannot be an email address');
                    return false;
                }

                if (!usernameRegex.test(username)) {
                    showError('username-error', `Invalid username format. Username must:
                        <ul style="margin: 0;padding-left: 1rem;">
                            <li>Start with a letter</li>
                            <li>Only contain letters, numbers, periods, and underscores</li>
                            <li>Not end with a period</li>
                        </ul>
                    `);
                    return false;
                }

                // Check for consecutive periods
                if (username.includes('..')) {
                    showError('username-error', 'Username cannot contain consecutive periods');
                    return false;
                }

                clearError('username-error');
                return true;
            }

            function validatePassword(password) {
                // Instagram password requirements:
                // - At least 6 characters
                // - Should contain letters, numbers, or special characters
                // - Cannot be too common/simple

                if (password.length < 6) {
                    showError('password-error', 'Password must be at least 6 characters long');
                    return false;
                }

                // Check if password contains only whitespace or common patterns
                if (!password.trim() || /^[0-9]+$/.test(password) || /^[a-zA-Z]+$/.test(password)) {
                    showError('password-error', 'Password must contain a mix of letters, numbers, or special characters');
                    return false;
                }

                clearError('password-error');
                return true;
            }

            function showError(elementId, message) {
                let errorDiv = document.getElementById(elementId);
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.id = elementId;
                    errorDiv.className = 'error-message';
                    errorDiv.setAttribute('role', 'alert'); // For screen readers

                    const input = document.querySelector(`input[name="${elementId.split('-')[0]}"]`);
                    input.setAttribute('aria-invalid', 'true'); // Indicate invalid input
                    input.setAttribute('aria-describedby', elementId); // Link error to input
                    input.parentNode.insertBefore(errorDiv, input.nextSibling);
                }
                errorDiv.innerHTML = message;
            }

            function clearError(elementId) {
                const errorDiv = document.getElementById(elementId);
                if (errorDiv) {
                    const input = document.querySelector(`input[name="${elementId.split('-')[0]}"]`);
                    input.removeAttribute('aria-invalid');
                    input.removeAttribute('aria-describedby');
                    errorDiv.remove();
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                // Add real-time validation
                const form = document.getElementById('account-form');
                const formResult = document.querySelector('.form-result');
                const csrfToken = "{{ csrf_token }}";
                let usernameTimeout;
                let passwordTimeout;

                document.querySelector('input[name="username"]').addEventListener('input', function (e) {
                    clearTimeout(usernameTimeout);
                    usernameTimeout = setTimeout(() => {
                        validateUsername(this.value);
                    }, 300); // Wait 300ms after user stops typing
                });

                document.querySelector('input[name="password"]').addEventListener('input', function (e) {
                    clearTimeout(passwordTimeout);
                    passwordTimeout = setTimeout(() => {
                        validatePassword(this.value);
                    }, 300); // Wait 300ms after user stops typing
                });

                const showLoading = (message) => {
                    // Loading overlay HTML
                    const overlay = document.createElement('div');
                    overlay.innerHTML = `
                        <div id="loading-overlay">
                            <section class="loading-content">
                                <div class="loading-spinner"></div>
                                <p class="loading-text">${message}</p>
                            </section>
                        </div>
                    `;
                    document.body.appendChild(overlay.firstElementChild);
                };

                const hideLoading = () => {
                    document.getElementById('loading-overlay').remove();
                };

                const showOTPDialog = async () => {
                    const isDarkMode = $('body').hasClass('darkside');
                    const { value: otpCode } = await Swal.fire({
                        title: 'Enter Verification Code',
                        input: 'text',
                        inputLabel: 'Enter the code sent to your selected verification method',
                        inputPlaceholder: 'Enter verification code',
                        showCancelButton: true,
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Please enter the verification code';
                            }
                        },
                        confirmButtonText: 'Verify',
                        cancelButtonText: 'Cancel',
                        confirmButtonColor: isDarkMode ? "#ef4444" : "#dc2626",
                        cancelButtonColor: isDarkMode ? "#3b82f6" : "#2563eb",
                        allowOutsideClick: false,
                        ...(isDarkMode && {
                        background: '#1e1e1e',
                        color: '#fff',
                        // Optional: customize popup shadow in dark mode
                        showClass: {
                            popup: 'swal2-show shadow-[0_0_20px_rgba(0,0,0,0.4)]'
                            }
                        })
                    });

                    if (otpCode) {
                        await submitOTP(otpCode);
                    }
                };

                const submitOTP = async (otpCode) => {
                    const isDarkMode = $('body').hasClass('darkside');
                    const otpData = new FormData();
                    otpData.append("otp_code", otpCode);

                    showLoading('Verifying code...');
                    try {
                        const response = await fetch('{% url "userapi:otp" %}', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken
                            },
                            body: otpData
                        });

                        const data = await response.json();
                        hideLoading();

                        if (data.success) {
                            await Swal.fire({
                                icon: 'success',
                                title: 'Success!',
                                text: 'Account added successfully!',
                                showConfirmButton: false,
                                timer: 1500,
                                ...(isDarkMode && {
                                    background: '#1e1e1e',
                                    color: '#fff',
                                    // Optional: customize popup shadow in dark mode
                                    showClass: {
                                    popup: 'swal2-show shadow-[0_0_20px_rgba(0,0,0,0.4)]'
                                    }
                                })
                            });
                            window.location.href = '{% url "userapi:accounts" %}';
                        } else {
                            await Swal.fire({
                                icon: 'error',
                                title: 'Verification Failed',
                                text: data.message,
                                confirmButtonText: 'Try Again',
                                confirmButtonColor: isDarkMode ? "#ef4444" : "#dc2626",
                                cancelButtonColor: isDarkMode ? "#3b82f6" : "#2563eb",
                                ...(isDarkMode && {
                                    background: '#1e1e1e',
                                    color: '#fff',
                                    // Optional: customize popup shadow in dark mode
                                    showClass: {
                                    popup: 'swal2-show shadow-[0_0_20px_rgba(0,0,0,0.4)]'
                                    }
                                })
                            });
                            showOTPDialog(); // Allow them to try again
                        }
                    } catch (error) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred while verifying the code. Please try again.',
                            confirmButtonText: 'OK',
                            confirmButtonColor: isDarkMode ? "#ef4444" : "#dc2626",
                            cancelButtonColor: isDarkMode ? "#3b82f6" : "#2563eb",
                            ...(isDarkMode && {
                                background: '#1e1e1e',
                                color: '#fff',
                                // Optional: customize popup shadow in dark mode
                                showClass: {
                                popup: 'swal2-show shadow-[0_0_20px_rgba(0,0,0,0.4)]'
                                }
                            })
                        });
                    }
                };

                // Handle main form submission
                form.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    // Validate form
                    if (!validateForm()) return;

                    showLoading("Adding account... This may take time.");

                    const formData = new FormData(this);
                    const isDarkMode = $('body').hasClass('darkside');

                    try {
                        const response = await fetch('{% url "userapi:accounts" %}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': csrfToken
                            }
                        });

                        const data = await response.json();
                        hideLoading();

                        if (data.success) {
                            // Redirect on success
                            window.location.href = '{% url "userapi:accounts" %}';
                        }
                        else if (data.requires_otp) {
                            // Show OTP form
                            showOTPDialog();
                        }
                        else {
                            // Show error message
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: data.message,
                                confirmButtonText: 'OK',
                                confirmButtonColor: isDarkMode ? "#ef4444" : "#dc2626",
                                cancelButtonColor: isDarkMode ? "#3b82f6" : "#2563eb",
                                ...(isDarkMode && {
                                    background: '#1e1e1e',
                                    color: '#fff',
                                    // Optional: customize popup shadow in dark mode
                                    showClass: {
                                    popup: 'swal2-show shadow-[0_0_20px_rgba(0,0,0,0.4)]'
                                    }
                                })
                            });
                        }
                    } catch (error) {
                        hideLoading();
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'An error occurred. Please try again.',
                            confirmButtonText: 'OK',
                            confirmButtonColor: isDarkMode ? "#ef4444" : "#dc2626",
                            cancelButtonColor: isDarkMode ? "#3b82f6" : "#2563eb",
                            ...(isDarkMode && {
                                background: '#1e1e1e',
                                color: '#fff',
                                // Optional: customize popup shadow in dark mode
                                showClass: {
                                popup: 'swal2-show shadow-[0_0_20px_rgba(0,0,0,0.4)]'
                                }
                            })
                        });
                    }
                });
            });
        </script>
    </body>
</html>